name: Sync Release Assets To Website

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to sync (example: v0.5.6-alpha)"
        required: true
        type: string
  release:
    types: [published]

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name || inputs.tag }}
    steps:
      - name: Checkout release ref
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Download release binaries
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          tag: ${{ env.RELEASE_TAG }}
          fileName: |
            bootloader.bin
            partitions.bin
            firmware.bin
            littlefs.bin
            version.json
          out-file-path: deploy
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy manifest file
        run: |
          set -euo pipefail
          cp manifest.json deploy/manifest.json

      - name: Verify deploy files
        run: |
          set -euo pipefail
          for f in bootloader.bin partitions.bin firmware.bin littlefs.bin version.json manifest.json; do
            test -s "deploy/$f" || { echo "Missing deploy/$f"; exit 1; }
          done
          ls -lh deploy

      - name: Upload to website
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.WEB_FTP_SERVER }}
          username: ${{ secrets.WEB_FTP_USERNAME }}
          password: ${{ secrets.WEB_FTP_PASSWORD }}
          protocol: ftps
          port: 21
          local-dir: deploy/
          server-dir: ${{ secrets.WEB_FTP_TARGET_DIR }}
